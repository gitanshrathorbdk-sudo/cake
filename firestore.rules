/**
 * Core Philosophy:
 * This ruleset uses a mixed model. User-specific data (like profiles) is
 * private and user-owned. Shared data, like public playlists, is accessible
 * to any authenticated user.
 *
 * Data Structure:
 * - /users/{userId} (User Profile - Private)
 * - /playlists/{playlistId} (Public Playlists - Shared)
 *
 * Key Security Decisions:
 * - Strict Ownership for User Data: A user can only access documents within
 *   their own `/users/{userId}` path.
 * - Public Read for Playlists: Any authenticated user can read the public
 *   playlists. To contribute, a user must be signed in.
 * - No User Listing: To protect user privacy, it is forbidden to query the
 *   top-level `/users` collection.
 * - Path-Based Security: Authorization primarily relies on the user's
 *   authentication status and the document path, avoiding complex `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Combines an ownership check with a check to ensure the document
     * already exists. This is critical for all update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * On create, validates that the incoming document's 'id' field matches
     * its document ID in the path. Enforces relational integrity.
     */
    function incomingDataMatchesDocId(docId) {
      return request.resource.data.id == docId;
    }

    /**
     * On update, ensures that the 'id' field of a document cannot be changed.
     * This prevents re-linking or re-assigning core documents.
     */
    function idIsImmutable() {
      return request.resource.data.id == resource.data.id;
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (get) An authenticated user reads their own profile. auth.uid: "user_abc", path: /users/user_abc
     * @deny (list) A user tries to list all other users in the system.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User enumeration is disallowed for privacy.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
    
    /**
     * @description Manages public playlists accessible by all authenticated users.
     * @path /playlists/{playlistId}
     * @allow (read) Any authenticated user can read playlists.
     * @allow (write) Any authenticated user can create, update, or delete playlists.
     * @principle Promotes a shared, collaborative environment for playlists.
     */
    match /playlists/{playlistId} {
        allow read, write: if isSignedIn();
    }
  }
}